{% extends 'fisheriescape/base.html' %}
{% load verbose_names %}
{% load i18n %}
{% load custom_filters %}
{% load static %}

{% block title_area %}
{% endblock %}

{% block crumbs %}
{% endblock %}


{% block content %}
    <div id="app" v-cloak>
        <div id="mySidebar" :class="(showSidebar) ? 'sidebar-opened':'sidebar-closed'">
            {% include "fisheriescape/_console.html" %}
        </div>
        <div :class="(showSidebar) ? 'main-opened':'main-closed'">

            <div class="container-fluid bg-light curvy">
                <div class="row">
                    <div class="col">
                        <h5>
                            {% trans "Map" %}
                        </h5>
                        <hr>
                    </div>
                </div>
                {#            <div v-if="projects_loading" class="loading mb-3 mt-3 text-center mt-5">#}
                {#                <div class="spinner-border mb-3" style="width: 10rem; height: 10rem;" role="status">#}
                {#                    <span class="sr-only"></span>#}
                {#                </div>#}
                {#            </div>#}
                <div class="row">
                    <div class="col my-auto">
                        <div v-if="dataReady" id="maptest">
                            <div>Choose filters on the left menu to display the map.</div>
                        </div>

                        <div v-else class="loading mb-3 mt-3 text-center mt-5">
                            <div class="spinner-border mb-3" style="width: 10rem; height: 10rem;" role="status">
                                <span class="sr-only"></span>
                            </div>
                            <h5>Waiting for database query to finish</h5>
                        </div>
                    </div>
                </div>

            </div>


        </div>
    </div>

{% endblock %}


{% block body_js %}
    {{ block.super }}

    {#    {% include "fisheriescape/map_component.html" %}#}

    <script type="application/javascript">
        const lobsterAreas = {{ lobster_areas | safe }};
        const SnowCrabAreas = {{ snow_crab_areas | safe }};
        const HerringAreas = {{ herring_areas | safe }};
        const GroundfishAreas = {{ groundfish_areas | safe }};
        const NAFOAreas = {{ nafo_areas | safe }};
        const NAFOSubAreas = {{ nafo_sub_areas | safe }};

        const areaOverlaysRawData = [lobsterAreas, SnowCrabAreas, HerringAreas, GroundfishAreas, NAFOAreas, NAFOSubAreas];

        var app = new Vue({
            el: '#app',
            delimiters: ["${", "}"],
            data: {
                showSidebar: true,
                message: "test message",
                features: [],
                count: 0,
                {#filteredData: [],#}

                projects_loading: false,
                help_text: true,
                dataReady: true,
                scale: [],

                // filters
                filter: {
                    is_hidden: "",
                    week: "",
                    species: "",
                    point: "",
                },

                // lists for filters
                speciesList: [],
                weekList: [],
                pointList: ["point1", "point2"],

                // map
                center: [37.7749, -122.4194],
                bounds: [],
            },
            methods: {
                {#bucketSort(array, bucketsCount, startValue = 0, maxValue) {#}
                {#    const buckets = {};#}
                {#    const bucketsSize = Math.floor((Math.floor(maxValue) - startValue) / bucketsCount);#}
                {##}
                {#    for (let i = 0; i < bucketsCount; i++) {#}
                {#        buckets[i * bucketsSize] = array.filter(value => value >= i * bucketsSize && value < (i + 1) * bucketsSize);#}
                {#    }#}
                {#console.log('buckets', buckets)#}
                {#console.log('array', array)#}
                {#    return buckets;                },#}

                search() {
                    this.getFeatures();
                },
                buildScale(maxValue) {
                    {#const allFsScores = features.map(feature => feature.properties.fs_score).sort((a, b) => a - b);#}
                    const stepsCount = 10;
                    console.log('maxValue', maxValue);
                    let stepsSize;
                    if (maxValue > 9) {
                        stepsSize = Math.floor((Math.floor(maxValue) / stepsCount));

                    } else {
                        stepsSize = (maxValue / stepsCount);
                    }
                    console.log('stepSize', stepsSize);
                    const scale = [];
                    for (let i = 0; i < stepsCount; i++) {
                        scale.push(parseFloat((i * stepsSize).toFixed(2)));
                    }

                    {#const scale = Object.keys(this.bucketSort(allFsScores, 10, maxValue));#}
                    console.log('scale', scale);
                    return scale;
                },
                getFeatures() {
                    this.projects_loading = true;
                    {#this.dataReady = false;#}
                    let featuresEndpoint = "/api/fisheriescape/scores-feature/?";

                    if (this.filter.species) featuresEndpoint += `species=${this.filter.species}&`;
                    if (this.filter.week) featuresEndpoint += `week=${this.filter.week}&`;
                    this.features = [];
                    apiService(featuresEndpoint)
                        .then(response => {
                            this.projects_loading = false;
                            this.dataReady = true;
                            this.features = response;
                            if (response.features.length) {
                                this.scale = this.buildScale(response.max_fs_score);
                            }
                            this.refreshMap();
                        });
                },
                getFilterData() {
                    apiService(`/api/fisheriescape/species/`).then(response => this.speciesList = response);
                    apiService(`/api/fisheriescape/week/`).then(response => this.weekList = response);
                },
                removeMap() {
                    if (this.map) {
                        this.map.remove();
                    }
                },
                checkFilters() {
                    this.help_text = !(this.filter.week && this.filter.species);
                },
                refreshMap() {
                    this.removeMap();
                    this.setupLeafletMap();
                },
                setupLeafletMap: function () {

                    // Create variable for different base maps

                    var light = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                        maxZoom: 18,
                        id: 'mapbox/light-v10',
                        tileSize: 512,
                        zoomOffset: -1,
                        accessToken: `{{ mapbox_api_key }}`
                    });

                    var streets = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                        maxZoom: 18,
                        id: 'mapbox/streets-v11',
                        tileSize: 512,
                        zoomOffset: -1,
                        accessToken: `{{ mapbox_api_key }}`
                    });

                    // Initiate filter layer for later, has to be done here so it can be toggled on when map is initiated
                    // Use FeatureGroup instead of layerGroup because featureGroup allows getBounds() method

                    var overlayObject = L.featureGroup();
                    // Create the map starting location and zoom level and tell it which layers to have

                    this.map = L.map('maptest', {
                        center: [48.46, -61.95],
                        zoom: 6,
                        layers: [streets, overlayObject] //this says what to have on by default
                    });


                    // Create subfunctions for polygon layer

                    function showInfo() {
                        this.setStyle({
                            'fillColor': '#689ae9'
                        });
                    }
                    function hideInfo() {
                        this.setStyle({
                            'fillColor': 'blue'
                        });
                    }


                    // Create Lobster polygon layer and use onEachFeature to show certain info for each feature

                    const areaOverlays = areaOverlaysRawData.reduce(
                        (acc, areas) => {
                            const areasName = areas.features[0].properties.layer_id
                            acc[areasName] = L.geoJSON(areas, {
                                style: function () {
                                    return {
                                        color: 'blue'
                                    };
                                },
                                onEachFeature: function (feature, layer) {
                                    myUrl = `http://dmapps/en/fisheriescape/fisheryarea/${feature.properties.pk}/view/`;
                                    layer.bindPopup(`Name: <a href = "${myUrl}">${feature.properties.name}</a></br>Layer ID: ${feature.properties.layer_id}</br>Region: ${feature.properties.region}`);
                                    layer.on({
                                        mouseover: showInfo,
                                        mouseout: hideInfo
                                    });
                                }
                            });
                            return acc
                        },{}
                    )

                    {#// Testing, this function takes in the getJSON call below and gets geoJson formatted data and makes layer#}
                    {#function createOverlay(data, layerName, style) {#}
                    {#  overlay = L.geoJson(data, { // Make the layer from the JSON and grab the handle.#}
                    {#    onEachFeature: function(feature, layer) {#}
                    {#       layer.bindPopup(`Species: ${feature.properties.species}</br>Week: ${feature.properties.week}</br>Site Score: ${feature.properties.site_score}`);#}
                    {#       layer.on({#}
                    {#mouseover: highlightFeature,#}
                    {#mouseout: resetHighlight,#}
                    {#       })#}
                    {#    },#}
                    {#style: gradientStyle,#}
                    {#// filter: function(feature) {#}
                    {#//    return feature.properties.week === 'Week 25';#}
                    {#// }#}
                    {#  });#}
                    {#  overlay.addTo(this.map);#}
                    {#  control.addOverlay(overlay, layerName); // Add the layer to the Layer Control.#}

                    {#// Define colour gradient for scores#}
                    {#function getColor(d) {#}
                    {#    return d > 30 ? '#800026' :#}
                    {#           d > 20  ? '#BD0026' :#}
                    {#           d > 14  ? '#E31A1C' :#}
                    {#           d > 10  ? '#FC4E2A' :#}
                    {#           d > 6  ? '#FD8D3C' :#}
                    {#           d > 3  ? '#FEB24C' :#}
                    {#           d > 1  ? '#FED976' :#}
                    {#                    '#FFEDA0';#}

                    // Define colour gradient for scores
                    getColor = (value) => {
                        console.log('value, scale', value, this.scale);
                        return value > this.scale[9] ? '#FF050B' :
                            value > this.scale[8] ? '#FF3105' :
                                value > this.scale[7] ? '#FF6305' :
                                    value > this.scale[6] ? '#FF9405' :
                                        value > this.scale[5] ? '#FFC605' :
                                            {#value > this.scale[6] ? '#FFF805' :#}
                                            value > this.scale[4] ? '#D4FF05' :
                                                {#value > this.scale[5] ? '#A3FF05' :#}
                                                {#    value > this.scale[9] ? '#71FF06' :#}
                                                value > this.scale[3] ? '#3FFF06' :
                                                    {#            value > this.scale[3] ? '#0EFF06' :#}
                                                    {#                value > this.scale[3] ? '#06FF2F' :#}
                                                    value > this.scale[2] ? '#06FF61' :
                                                        {#    value > this.scale[2] ? '#06FF93' :#}
                                                        value > this.scale[1] ? '#06FFC4' :
                                                            '#06FFF6';
                    };

                    // Define polygon style
                    function gradientStyle(feature) {
                        // console.log(feature)
                        return {
                            fillColor: getColor(feature.properties.fs_score),
                            weight: 0.5,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    }

                    // Highlight the hexagon on mouseover
                    function highlightFeature(e) {
                        var layer = e.target;

                        layer.setStyle({
                            weight: 5,
                            color: '#666',
                            dashArray: '',
                            fillOpacity: 0.7
                        });

                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                            layer.bringToFront();
                        }
                        info.update(layer.feature.properties);
                    }

                    // Reset Highlight on mouseout -- had to move this inside getJSON
                    {#function resetHighlight(e) {#}
                    {#   overlayTest.resetStyle(e.target);#}
                    {#   info.update();#}


                    // getting really close! just need to pass the filter to a new var outside the getJSON; need async get after filter is updated?
                    var getWeek = `${this.filter.week}`;
                    {#console.log(getWeek)#}

                    var getSpecies = `${this.filter.species}`;
                    {#console.log(getSpecies)#}

                    // trying without getJSON, use method from Vue --- maybe only grab the already filtered data to reduce lag and take away need to filter in layer??

                    var overlayTest = new L.geoJson(this.features, { // Make the layer from the JSON and grab the handle.
                        onEachFeature: function (feature, layer) {
                            layer.bindPopup(
                                `Id: ${feature.id}</br>
                                Grid-id: ${feature.properties.grid_id}</br>
                                Species: ${feature.properties.species}</br>
                                Week: ${feature.properties.week}</br>
                                FS Score: ${feature.properties.fs_score}`);
                            layer.on({
                                mouseover: highlightFeature,
                                mouseout: function resetHighlight(e) {
                                    overlayTest.resetStyle(e.target);
                                    info.update();
                                }
                            });

                        },
                        style: gradientStyle,
                        filter: function (feature) {
                            thingy = `Week ${getWeek}`;
                            {#console.log(thingy)#}
                            thingy2 = `${getSpecies}`;
                            {#console.log(thingy2)#}

                            // this works but only once you've chosen a species and a week -- add more logic or do something to show they have to pick both
                            if (feature.properties.species && feature.properties.week) return (feature.properties.species === thingy2 && feature.properties.week === thingy);
                            {#|| (feature.properties.week) return (feature.properties.week === thingy);#}
                        }
                        {#filter: function(feature) {#}
                        {#    return feature.properties.species === this.filter.species;#}
                    }).addTo(overlayObject);

                    // Don't go down this path friends, it just leads to madness.. should have realized much earlier that all that was
                    // needed was to get the json from a Vue method instead of trying to get it the way I've done in non-vue templates
                    // this works but because it's async, I couldn't figure out how to get the bounds of the layer that's created by it

                    {##}
                    {#                   var boundingNELat = []#}
                    {#                   var boundingNELng = null#}
                    {#                   var boundingNorthEast = L.latLng(40.712, -74.227)#}
                    {#                   var boundingSouthWest = L.latLng(40.774, -74.125)#}
                    {#                   var boundsForReal = L.latLngBounds(boundingSouthWest, boundingNorthEast)#}

                    {#// this works but had to add leaflet-ajax to static - but not sure how to get filter#}
                    {#$.getJSON(url, function(data){#}
                    {#    overlayTest = new L.geoJson(data, { // Make the layer from the JSON and grab the handle.#}
                    {#        onEachFeature: function (feature, layer) {#}
                    {#            layer.bindPopup(#}
                    {#                `Id: ${feature.id}</br>#}
                    {#                Grid-id: ${feature.properties.grid_id}</br>#}
                    {#                Species: ${feature.properties.species}</br>#}
                    {#                Week: ${feature.properties.week}</br>#}
                    {#                Site Score: ${feature.properties.site_score}`);#}
                    {#            layer.on({#}
                    {#                mouseover: highlightFeature,#}
                    {#                mouseout:  function resetHighlight(e) {#}
                    {#                           overlayTest.resetStyle(e.target);#}
                    {#                           info.update();#}
                    {#                        }#}
                    {#            })#}
                    {##}
                    {#        },#}
                    {#        style: gradientStyle,#}
                    {#        filter: function(feature) {#}
                    {#            thingy = `Week ${getWeek}`#}
                    {#console.log(thingy)#}
                    {#            thingy2 = `${getSpecies}`#}
                    {#console.log(thingy2)#}
                    {##}
                    {#            // this works but only once you've chosen a species and a week -- add more logic or do something to show they have to pick both#}
                    {#            if (feature.properties.species && feature.properties.week) return (feature.properties.species === thingy2 && feature.properties.week === thingy);#}
                    {#|| (feature.properties.week) return (feature.properties.week === thingy);#}
                    {#        }#}
                    {#filter: function(feature) {#}
                    {#    return feature.properties.species === this.filter.species;#}
                    {#    }).addTo(overlayObject);#}
                    {#overlayTest.on('data:loaded', function() {#}
                    {#console.log(overlayObject.getBounds())#}
                    {#this.map.(overlayObject.getBounds())#}
                    {#    if (thingy !== 'Week ' && thingy2 !== '') {#}
                    {#console.log(overlayTest.getBounds())#}
                    {#bounding.push(overlayTest.getBounds())#}
                    {#boundingNorthEast.push(overlayTest.getBounds().getNorthEast())#}
                    {#boundingSouthWest.push(overlayTest.getBounds().getSouthWest())#}
                    {#console.log(overlayTest)#}
                    {#this.bounds = (overlayTest.getBounds())#}
                    {#var bounding = (overlayTest.getBounds().getNorthEast());#}
                    {#console.log(bounding.lat)#}
                    {#console.log(bounding.lng)#}
                    {#boundingNELat.lat = bounding.lat.toString()#}
                    {#boundingNELat.lng = bounding.lng#}
                    {#console.log(boundingNELat.lat)#}
                    {#this.boundingNELng= bounding.lng#}
                    {#console.log(bounding)#}
                    {#var northEast = (overlayTest.getBounds().getNorthEast());#}
                    {#    southWest = (overlayTest.getBounds().getSouthWest());#}
                    {#bounds = L.latLngBounds(southWest, northEast)#}
                    {#console.log(bounds)#}
                    {#console.log(bounds.getCenter())#}
                    {#this.map.setView(new L.LatLng(40.737, -73.923), 8);#}
                    {#    }#}
                    {#    console.log(overlayObject.getBounds())#}
                    //});


                    // Add hover info control box with info

                    var info = L.control({position: 'bottomleft'});

                    info.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                        this.update();
                        return this._div;
                    };

                    // method that we will use to update the control based on feature properties passed
                    info.update = function (props) {
                        this._div.innerHTML = '<h4>Fisheriescape Scores</h4>' + (props ?
                            '<b>' + props.species + '</b><br /> FS Score:' + props.fs_score + '</b><br />' + props.week
                            : 'Hover over a hexagon');
                    };

                    info.addTo(this.map);

                    // Custom Legend

                    var legend = L.control({position: 'bottomright'});

                    legend.onAdd = map => {
                        console.log('hehe');
                        var div = L.DomUtil.create('div', 'info legend'),
                            {#grades = [0, 1, 2, 3, 6, 9, 12, 15, 17, 20, 22, 25, 27, 29, 30],#}
                            grades = this.scale,
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                            div.innerHTML +=
                                '<i style="background:' + getColor(grades[i] + 0.01) + '"></i> ' +
                                grades[i] + (grades[i + 1] ? ' &ndash; ' + grades[i + 1] + '<br>' : '+');
                        }

                        return div;
                    };

                    legend.addTo(this.map);

                    // Create basemaps variable and add basemaps desired to it as options

                    var baseMaps = {
                        "Light": light,
                        "Streets": streets,
                    };

                    // Create overlay variable and add overlays desired
                    // Uses plugin from: https://github.com/ismyrnow/leaflet-groupedlayercontrol

                    var groupedOverlays = {
                        "Fisheriescape Scores": {
                            [this.filter.species]: overlayObject,
                        },
                        "Fishing Areas": areaOverlays,
                    };

                    // Create the control layer box and add baseMaps and overlayMaps to it

                    {#L.control.layers(baseMaps, groupedOverlays).addTo(this.map);#}
                    L.control.groupedLayers(baseMaps, groupedOverlays).addTo(this.map);

                    // check if species and week filter has been chosen and if so get the bounds of the object
                    if (this.filter.species && this.filter.week) return this.map.fitBounds(overlayObject.getBounds(), {padding: [50, 50]});

                },
            },
            async setup() {
                {#await this.getTest();#}
                {#await this.dataReady;#}
                this.setupLeafletMap();
            },
            created() {
                {#this.getTest();#}
                {#this.getFilteredData("/api/fisheriescape/scores/?species=Atlantic Halibut");#}
                this.getFilterData();

            },
            {#async mounted() {#}
            {#     await this.dataReady;#}
            {#     this.setupLeafletMap();#}
            {##}
            {# },#}
            beforeDestroy() {
                if (this.map) {
                    this.map.remove();
                }
            }
        });

    </script>

    <script type="text/javascript" src="{% static "js/clickableTableRows.js" %}?version=1.1.7"></script>
    <script type=" text/javascript" src="{% static "js/popItOut.js" %}?version=1.2.2"></script>
    <script type=" text/javascript" src="{% static "js/underDevelopment.js" %}?version=1.2.4"></script>


{% endblock %}
